---
title: "Notes on statistical analysis"
author: "Katerina Symiakaki"
date: "Created on 13/12/2022. Last update on `r format(Sys.time(), '%d/%m/%Y')`."
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(error = TRUE)
```

Here I plan to write what I try and don't try for the analysis of data from the experiment in Sweden.

Data produced from microscope counts. Magnification always 1000x. Count to about 100 cells total. Count only what is inside the square area in the ocular lens. Sides of the square are 100 microns.

Area of square = 0.1 \* 0.1 (mm)\
Area of the filter = pi \* (21/2)^2^ (filter diameter is 25 mm)\
Volume filtered = 10 mL

The volume of 1 field of view is (in mL):

```{r}
Vp = 10 * (0.1 * 0.1) / (pi * (21/2)^2)
```

```{r, echo=F, message=F, warning=F}
library(tidyverse)
library(readxl)

#needed for the plots 
trt.cols <- c(`C`= "#000000", #black - C
              `D`= "#0a8754", #g - D
              `I`= "#4472ca", #blu - I
              `E`= "#e84855") #r - E
mes.cols <- c(`1` = "#333333", `7` = "#000000", `16` = "#b3b3b3", #black - C
              `9` = "#e84855", `4`= "#8b2b33", `6` = "#f19199", #r - E
              `11` = "#0a8754",`8` = "#075f3b", `13` = "#54ab87", #g - D
              `12` = "#4472ca", `3`= "#30508d", `14` = "#7c9cda") #blu - I
              
             
              
group_names <- as_labeller(c(`aHF` = "Heterotrophs",
                             `aMF` = "Mixotrophs",
                             `aPF` = "Phototrophs"))
group_ir <- as_labeller(c(`HFir` = "Heterotrophs",
                          `MFir` = "Mixotrophs"))
```

Load data\
*The range specified includes ALL 0.8 samples. It will fill up as more get analyzed, but for now just filter the area you need*

```{r load data, message=FALSE, warning=FALSE}
master.dat <- read_xlsx("SITES_microscope_data_sheet.xlsx", 
                        sheet = 1, 
                        range = "A1:T217", 
                        col_names = T)

# for some reason all number columns are characters (possibly because of the NAs in most rows). Let's convert that 
master.dat[,14:20] <- lapply(master.dat[,14:20], as.numeric)
master.dat$Mesocosm <- as.factor(master.dat$Mesocosm)
master.dat$Mes_ID <- as.factor(master.dat$Mes_ID)

# some basic cleaning - wrangling
partial_dat <- master.dat %>% 
                select(-c(Date,Date_analysed,Box,Comments,`Photos/ImageJ`)) %>% 
                mutate(
#maybe I need to do more factor stuff with other columns
                Treatment = fct_relevel(Treatment, c("C","D","I","E")),
                Tot_cells = HF_total + PF + MF,
# calculate ingestion rates - NOW IT'S COUNTS
                Mir = FLBinMF_total / (MF * 0.5),
                Hir = FLBinHF_total / (HFwFLB * 0.5),
# calculate abundances
                Vol = Fields_counted * Vp,
                aHF = as.integer(as.character(HF_total/Vol)),
                aMF = MF/Vol, 
                aPF = PF/Vol) %>% 
  
# filter for Incubation 2 and T30 
  
                filter(Incubation == 2 
                       # & Time_point == "Tend"
                )
                #        ) %>% 
                # drop_na()

```

# EDA

do some stats\
Histogram with the distribution of counts

```{r count hist, message=FALSE, eval = F}
summary(partial_dat)

partial_dat %>% 
  filter(Time_point == "Tend") %>% 
  pivot_longer(cols = c(HF_total, PF, MF), names_to = "group", values_to = "counts") %>% 
  ggplot(., aes(x = counts)) + 
  geom_histogram() + 
  facet_grid(cols = vars(group))

```

```{r abund hist, eval=F, message=FALSE}

partial_dat %>% 
  pivot_longer(cols = c(aHF, aPF, aMF), names_to = "group", values_to = "abundance") %>% 
  ggplot(., aes(x = abundance)) + 
  geom_histogram() + 
  facet_grid(cols = vars(group))

```

```{r, eval=F}

mean.mes <- partial_dat %>% 
  filter(Time_point == "Tend") %>% 
  pivot_longer(cols = c(aHF, aPF, aMF), names_to = "group", values_to = "abundance") %>% 
  group_by(
    # Incubation,
    Treatment,
    Mes_ID,
    group) %>% 
  summarise(mean = mean(abundance), 
            sd = sd(abundance))

mean.trt <- partial_dat %>% 
  filter(Time_point == "Tend") %>% 
  pivot_longer(cols = c(aHF, aPF, aMF), names_to = "group", values_to = "abundance") %>% 
  group_by(
    # Incubation,
    Treatment,
    group) %>% 
  summarise(mean = mean(abundance), 
            sd = sd(abundance))

ggplot(mean.trt, aes(x=Treatment, y=mean)) +
  geom_point()+
  geom_point(mean.mes, aes(x=mean.mes$Treatment, y=mean.mes$mean, fill=mean.mes$Mes_ID))+
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd),
                width=.2,
                position = position_dodge(0.05)) +
    facet_grid(cols = vars(group))

```

```{r}

partial_dat %>% 
  pivot_longer(cols = c(aHF, aPF, aMF), names_to = "group", values_to = "abundance") %>% 
  ggplot(., aes(x = Treatment, y = abundance)) +
  geom_boxplot(alpha = 0.8) +
  geom_point(aes(x = Treatment, y = abundance, color = Mes_ID),
             position = "jitter", 
             alpha = 0.6,
             # shape = 1, stroke = 0.7
  ) +
  ylab("Abundance cells/mL")+
  facet_grid(cols = vars(group), 
             labeller = group_names)+
  scale_color_manual(values = mes.cols)+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "grey96"),
        axis.text.x = element_text(size = 10),
        strip.text.x = element_text(size= 12))
```

# Serious stats {.tabset}

GLMM

## Heterotrophic

```{r, echo=T}

library(glmmTMB)
library(ggeffects)
library(performance)
library(DHARMa)

hm = glmmTMB(aHF ~ 1
            + Treatment 
            + (1|Mesocosm),
            # offset = Vol,
            family = poisson(),
            data = partial_dat);summary(hm)

check_model(hm) # why error????

h.pred <- ggpredict(hm, terms = c("Treatment"))

plot(h.pred)
 # simulateResiduals(fittedModel = hm, plot = T)

```

*Something else to try*\
influence measures\
quantify the effects of particular observations, or groups of observations, on the results of a statistical model

```{r}
source(system.file("other_methods","influence_mixed.R", package="glmmTMB"))
# hm_inf_time <- system.time(
hm_inf <- influence_mixed(hm, groups="Mesocosm")
# )

car::infIndexPlot(hm_inf)
```

## Mixotrophic

```{r}
mm = glmmTMB(aMF ~ 1
            + Treatment 
            + (1|Mesocosm),
            # offset = log(Fields_counted),
            family = poisson(),
            data = partial_dat);summary(mm)

check_model(mm) # why error????

plot(ggpredict(mm, terms = c("Treatment")))
# plot(simulateResiduals(fittedModel = mm))

```

influence measures

```{r}
source(system.file("other_methods","influence_mixed.R", package="glmmTMB"))
# hm_inf_time <- system.time(
mm_inf <- influence_mixed(mm, groups="Mesocosm")
# )

car::infIndexPlot(mm_inf)
```

## Phototrophic

```{r}
pm = glmmTMB(aPF ~ 1
            + Treatment 
            + (1|Mesocosm),
            # offset = log(Fields_counted),
            family = poisson(),
            data = partial_dat);summary(pm)

check_model(pm) # why error????

plot(ggpredict(pm, terms = c("Treatment")))
# simulateResiduals(fittedModel = pm, plot = T)

```

influence measures

```{r}
source(system.file("other_methods","influence_mixed.R", package="glmmTMB"))
# hm_inf_time <- system.time(
pm_inf <- influence_mixed(pm, groups="Mesocosm")
# )

car::infIndexPlot(pm_inf)
```

##  {.unnumbered}

For some reason there is a difference if I use `Mesocosm` or `Mes_ID` for the random effects for all three groups (HF-MF-PF). Results **don't change when changing the class** (factor vs character).

1st case:

|                      |           |           |
|----------------------|-----------|-----------|
| Groups Name          | Variance  | Std.Dev   |
| Mesocosm (Intercept) | 5.588e-09 | 7.476e-05 |

2nd case:

|                    |          |           |
|--------------------|----------|-----------|
| Groups Name        | Variance | Std.Dev   |
| Mes_ID (Intercept) | 2.26e-09 | 4.754e-05 |

The Bayes way

```{r, eval=F}

library(brms)

mb = brm(bf(aHF ~ Treatment 
            + (1|Mesocosm)),
            # + offset(log(Fields_counted))),
         family = gaussian(link = "log"),
         chains = 4,
         iter = 2000,
         cores = 4,
         backend = "cmdstanr", 
         data = partial_dat)

pp_check(mb, ndraws = 1e2) 
plot(mb) 
summary(mb)



plot(conditional_effects(mb), ask = FALSE) 
```

integer-gaussian \> numeric-gaussian \> integer-poisson



# Bacterial counts

The factor to calculate the abundance (volume of 1 field of view) is now different for each sample, depending on how I counted. The volume filtered for all samples is 5 mL and the filter area is the same, diameter of 21 mm.

```{r load bact data, message=FALSE, warning=FALSE}
bact.dat <- read_xlsx("SITES_microscope_data_sheet.xlsx", 
                        sheet = 2,  
                        range = "A1:N37", # change accordingly
                        col_names = T) %>% 
  
  
  mutate(factor = (5 * Area)/(pi * (21/2)^2),
         HB_abund = HB/(Fields_counted*factor),
         FLB_abund = FLB/(Fields_counted*factor),
         CY_abund = CY/(Fields_counted*factor),
         FLB_perc = FLB_abund/HB_abund,
         
         Treatment = fct_relevel(Treatment, c("C","D","I","E")))

bact.dat$Mesocosm <- as.factor(bact.dat$Mesocosm)
bact.dat$Mes_ID <- as.factor(bact.dat$Mes_ID)
```

Plot
```{r bact plot}
bact.dat %>% 
  pivot_longer(cols = c(HB_abund, FLB_abund, CY_abund), names_to = "group", values_to = "abundance") %>% 
  ggplot(., aes(x = Treatment, y = abundance)) +
  geom_boxplot(alpha = 0.8) +
  geom_point(aes(x = Treatment, y = abundance, color = Mes_ID),
             position = "jitter", 
             alpha = 0.6,
             # shape = 1, stroke = 0.7
  ) +
  ylab("Abundance cells/mL")+
  facet_grid(cols = vars(group))+
  scale_color_manual(values = mes.cols)+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "grey96"),
        axis.text.x = element_text(size = 10),
        strip.text.x = element_text(size= 12))
```

The % of FLB is in most cases (incubation 2) < 10% of the community. This is not good and may explain why I have few ingestions overall. Sherr & Sherr 1993 suggest at least 2*10^6 FLB for incubations with flagellates.

# Ingestion rates

Plot Ingestion rate - not corrected

```{r, eval=FALSE}
partial_dat %>% 
  pivot_longer(cols = c(Mir, Hir), names_to = "group", values_to = "ingest_rates") %>% 
  ggplot(., aes(x = Treatment, y = ingest_rates)) +
  facet_grid(cols = vars(group), 
             labeller = group_ir)+
  # geom_boxplot(alpha = 0.8) +
  geom_point(aes(color = Mes_ID),
             position = "jitter", 
             alpha = 0.5,
             # shape = 1, stroke = 0.7
  ) +
  scale_color_manual(values = mes.cols)+
  geom_point(aes(color = Treatment), stat = "summary", fun = "mean",size = 4)+
  geom_pointrange(data =trt.mean.ir,
             aes(x = trt.mean.ir$Treatment,
                 y = trt.mean.ir$trt.mean,
                 ymin=trt.mean.ir$trt.mean-trt.mean.ir$trt.sd,
                 ymax=trt.mean.ir$trt.mean+trt.mean.ir$trt.sd,
                fill = trt.mean.ir$Treatment),
             size = .6, stat = "identity", show.legend = F)+
  # geom_pointrange(stat = "summary", fun.y = mean, 
  #                 fun.ymin = mean-sd, fun.yman = mean+sd)
  scale_fill_manual(values = trt.cols)+
  ylab(expression("Ingestion rate"~"bacteria" ~ "cells"^{-1} ~"h"^{-1}))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "grey96"),
        axis.text.x = element_text(size = 10),
        strip.text.x = element_text(size= 12))

```

## Correcting ingestion rates

I want to calculate -and plot- the "corrected" ingestion rates several (or as many possible) ways

1.  The "traditional" method\

```{r ingestion data, message=F}
ingest <- read_xlsx("SITES_microscope_data_sheet.xlsx", 
                        sheet = 3,  
                        range = "A1:L2233", # change accordingly
                        col_names = T) 

working <- ingest %>% 
  group_by(Treatment, Mes_ID, Sample, Replicate, Time_point, Grazer) %>% 
  summarise(cell_num = sum(FLB_presence),
            flb_ingest = sum(Num_FLB, na.rm = T)) %>% # pay attention here! what's happening with the NAs?
  ungroup() %>% 
  separate(Sample, into = c("inc", "Bag", "time", "filter"), sep = "_", remove = T) %>% 
  select(-inc, -time, -filter) %>% 
  pivot_wider(names_from = c(Time_point, Grazer), 
              values_from = c(cell_num, flb_ingest)) %>% 
  mutate(MF_corr = cell_num_Tend_MF - cell_num_Tstart_MF,
         HF_corr = cell_num_Tend_HF - cell_num_Tstart_HF,
         HFir = flb_ingest_Tend_HF/(HF_corr*0.5),
         MFir = flb_ingest_Tend_MF/(MF_corr*0.5),
         Treatment = fct_relevel(Treatment, c("C","D","I","E"))) %>% 
  select(-contains(c("cell_num_T", "Tstart", "flb_ingest"))) 

working$Mes_ID <- as.factor(working$Mes_ID)

#if I replace with NA it gives NA in the summary
working[sapply(working, is.infinite)] <- 0

grazing =  left_join(working, bact.dat, by = c("Treatment", "Mes_ID", "Replicate"), copy = T) %>% 
  select(-c(9:20), -FLB_abund, -CY_abund) %>% 
  mutate(mCR = MFir/HB_abund, # in mL
         hCR = HFir/HB_abund)

# for plotting
sumIR <- working %>% 
  pivot_longer(cols = c(MFir, HFir), names_to = "group", values_to = "IR") %>% 
  group_by(Treatment, group) %>% 
  summarise(IR.mean = mean(IR), 
            IR.sd = sd(IR))

# work in progress - I want to remove the cells that have the same number of flb in the start and end
working <- ingest %>% 
  separate(Sample, into = c("inc", "Bag", "time", "filter"), sep = "_", remove = T) %>% 
  select(-inc, -time, -filter) %>% 
  group_by(Treatment, Mes_ID, Bag, Grazer) %>% 
  mutate(nomnom = paste0(FLB_presence, "-", Num_FLB))

  pivot_wider(names_from = c(Time_point, Grazer), 
              values_from = c(cell_num, flb_ingest)) %>% 
  mutate(MF_corr = cell_num_Tend_MF - cell_num_Tstart_MF,
         HF_corr = cell_num_Tend_HF - cell_num_Tstart_HF) %>% 
  select(-contains("cell_num_T"))
```

Plot the thing
```{r}
working %>% 
  pivot_longer(cols = c(MFir, HFir), names_to = "group", values_to = "IR") %>% 
  ggplot(., aes(x = Treatment, y = IR)) +
  facet_grid(cols = vars(group), 
             labeller = group_ir)+
  # geom_boxplot(alpha = 0.8) +
  geom_point(aes(color = Mes_ID),
             position = "jitter", 
             alpha = 0.5,
             # shape = 1, stroke = 0.7
  ) +
  scale_color_manual(values = mes.cols)+
  geom_point(aes(color = Treatment), stat = "summary", fun = "mean",size = 4)+
  geom_pointrange(data =sumIR,
             aes(x = sumIR$Treatment,
                 y = sumIR$IR.mean,
                 ymin=sumIR$IR.mean-sumIR$IR.sd,
                 ymax=sumIR$IR.mean+sumIR$IR.sd,
                fill = sumIR$Treatment),
             size = .6, stat = "identity", show.legend = F)+
  # geom_pointrange(stat = "summary", fun.y = mean, 
  #                 fun.ymin = mean-sd, fun.yman = mean+sd)
  scale_fill_manual(values = trt.cols)+
  ylab(expression("Ingestion rate"~"bacteria" ~ "cells"^{-1} ~"h"^{-1}))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "grey96"),
        axis.text.x = element_text(size = 10),
        strip.text.x = element_text(size= 12))
```
possible outliers for MF: E1a (4), I1a (3), D3a (11) - the 0  
possible outliers for HF: I3c (12) - the 0, D2c (8)  

2.  The "growth rate" method

```{r}

```

If I just make a model with the number of ingested bacteria as a response variable, and have the data of occurrences (ie cells) what is the offset?

**Need to standardize the ingestion rates somehow. I have \~ 100 cells in each sample but mot exactly**

## Statistics 
```{r}
ir.stat = grazing %>% 
  filter(Bag!="E1a" & Bag!="I1a")


IR.mod = glmmTMB(MFir ~ 1
            + Treatment 
            + (1|Mes_ID),
            # offset = log(Fields_counted),
            family = gaussian(),
            data = ir.stat);summary(IR.mod)

check_model(IR.mod) # why error????

plot(ggpredict(IR.mod, terms = c("Treatment")))
plot(simulateResiduals(fittedModel = IR.mod))
```
Model diagnostics are better when omitting the outliers (use the ir.stat dataframe). "Better" significance if not.
