---
title: "Notes on statistican analysis"
author: "Katerina Symiakaki"
date: "Created on 13/12/2022. Last update on `r format(Sys.time(), '%d/%m/%Y')`."
output: html_document
---

Here I plan to write what I try and don't try for the analysis of data from the experiment in Sweden.

Data produced from microscope counts. Magnification always 1000x. Count to about 100 cells total. Count only what is inside the square area in the ocular lens. Sides of the square are 100 microns. **NEED TO CHECK THAT**

Area of square = 0.1 \* 0.1 (mm)\
Area of the filter = pi \* (25/2)\^2 (filter diameter is 25 mm)\
Volume filtered = 10 mL

The volume that I examined is (in mL):

```{r}
V = (0.1 * 0.1 * 10) / (pi * (25/2)^2)
```

```{r, echo=F, message=F, warning=F}
library(tidyverse)
library(readxl)
```

Load data  
*The range specified includes ALL 0.8 samples. It will fill up as more get analyzed, but for now just filter the area you need*

```{r, message=FALSE, warning=FALSE}
master.dat <- read_xlsx("SITES_microscope_data_sheet.xlsx", 
                        sheet = 2, 
                        range = "A1:T217", 
                        col_names = T)

# for some reason all number columns are characters. Let's convert that 
master.dat[,14:20] <- lapply(master.dat[,14:20], as.numeric)


# some basic cleaning - wrangling
partial_dat <- master.dat %>% 
                select(-c(Date,Date_analysed,Box,Comments,`Photos/ImageJ`)) %>% 
                mutate(
#maybe I need to do more factor stuff with other columns
                Treatment = fct_relevel(Treatment, c("C","D","I","E")),
                Tot_cells = HF_total + PF + MF,
# calculate ingestion rates - NOW IT'S COUNTS
                Mir = FLBinMF_total / (MF * 0.5),
                Hir = FLBinHF_total / (HFwFLB * 0.5),
                Vol = Fields_counted * V * 1e3) %>% 
# filter for Incubation 2 and T30 
                filter(Incubation == 2 & Time_point == "Tend") %>% 
                drop_na()

```

### EDA

do some stats\
Histogram with the distribution of counts

```{r, message=FALSE}
summary(partial_dat)

partial_dat %>% 
  pivot_longer(cols = c(HF_total, PF, MF), names_to = "group", values_to = "counts") %>% 
  ggplot(., aes(x = counts)) + 
  geom_histogram() + 
  facet_grid(cols = vars(group))

```

### Serious stats {.tabset}

GLMM

#### Heterotrophic

```{r, echo=T}

library(glmmTMB)
library(ggeffects)
library(DHARMa)

hm = glmmTMB(HF_total/Vol ~ 1
            + Treatment 
            + (1|Mesocosm),
            # offset = log(Fields_counted),
            family = nbinom2(),
            data = partial_dat);summary(hm)

#check_model(hm) # why error????

plot(ggpredict(hm, terms = c("Treatment")))
# simulateResiduals(fittedModel = hm, plot = T)

```


#### Mixotrophic

```{r}
mm = glmmTMB(MF/Vol ~ 1
            + Treatment 
            + (1|Mesocosm),
            # offset = log(Fields_counted),
            family = nbinom2(),
            data = partial_dat);summary(mm)

#check_model(mm) # why error????

plot(ggpredict(mm, terms = c("Treatment")))
# simulateResiduals(fittedModel = mm, plot = T)

```

#### Phototrophic

```{r}
pm = glmmTMB(PF/Vol ~ 1
            + Treatment 
            + (1|Mesocosm),
            # offset = log(Fields_counted),
            family = nbinom2(),
            data = partial_dat);summary(pm)

#check_model(pm) # why error????

plot(ggpredict(pm, terms = c("Treatment")))
# simulateResiduals(fittedModel = pm, plot = T)

```

###  {.unnumbered}

For some reason there is a difference if I use `Mesocosm` or `Mes_ID` for the random effects for all three groups (HF-MF-PF). Results **don't change when changing the class** (factor vs character).

1st case:

|                      |           |           |
|----------------------|-----------|-----------|
| Groups Name          | Variance  | Std.Dev   |
| Mesocosm (Intercept) | 5.588e-09 | 7.476e-05 |

2nd case:

|                    |          |           |
|--------------------|----------|-----------|
| Groups Name        | Variance | Std.Dev   |
| Mes_ID (Intercept) | 2.26e-09 | 4.754e-05 |

The Bayes way

# ```{r}
library(brms)

mb = brm(bf(HF_total/Vol ~ 0
            + Treatment 
            + (1|Mesocosm)),
         chains = 4,
         iter = 20000,
         cores = 4,
         adapt_delta = 0.99,
         backend = "cmdstanr", 
         data = partial_dat)

pp_check(mb, ndraws = 1e2)
plot(mb)
summary(mb)

plot(conditional_effects(mb), ask = FALSE)
```
